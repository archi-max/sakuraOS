<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>QEMU on browser (RISCV64)</title>
    <link rel="stylesheet" href="./vendor/xterm.css" />
    <style>
  html, body {
    height: 100%;
    margin: 0;
  }

  #terminal {
    height: 100vh;   /* full viewport height */
    width: 100vw;    /* full viewport width  */
  }
</style>
  </head>
  <body>
    <div id="terminal"></div>
    <div id="terminal0"></div>
    <div id="terminal1"></div>
    <!-- preload the filesystem bundle (qemu-system-riscv64.data) -->
    <script src="./load.js"></script>
    <script type="module">
      import 'https://unpkg.com/xterm@5.3.0/lib/xterm.js';
      import 'https://unpkg.com/xterm-pty/index.js';
      import './module.js';
      import initEmscriptenModule from './out.js';

      const xterm =new Terminal({
        cols: 160,       // logical width for your ASCII app
        rows: 50,       // logical height
        fontSize: 14,   // make it visually bigger
        convertEol: true,
      });
      // const term0 = new Terminal();
      // const term1 = new Terminal();

      xterm.open(document.getElementById("terminal"));

      // function fitAndResize() {
      //   fitAddon.fit();                        // resize xterm to container
      //   master.resize(xterm.cols, xterm.rows); // tell the PTY / guest about new size
      // }

      // fitAndResize();
      // window.addEventListener('resize', fitAndResize);
      // term0.open(document.getElementById("terminal0"));
      // term1.open(document.getElementById("terminal1"));

      const { master, slave } = openpty();
      // const { master: master0, slave: slave0 } = openpty();
      // const { master: master1, slave: slave1 } = openpty();

      // term0.loadAddon(master0);
      // term1.loadAddon(master1);
      xterm.loadAddon(master);

      // Module is defined/modified in module.js
      Module.pty = slave;
      // Tell the worker where the main JS lives
      Module['mainScriptUrlOrBlob'] = location.origin + "/out.js";

      (async () => {
        const instance = await initEmscriptenModule(Module);

        // Adjust TTY poll to respect xterm-pty readiness
        const oldPoll = Module['TTY'].stream_ops.poll;
        const pty = Module['pty'];
        Module['TTY'].stream_ops.poll = function (stream, timeout) {
          if (!pty.readable) {
            return (pty.readable ? 1 : 0) | (pty.writable ? 4 : 0);
          }
          return oldPoll.call(stream, timeout);
        };
      })();
    </script>
  </body>
</html>
